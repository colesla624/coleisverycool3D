<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lava Monkey Chase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; touch-action:none; }
    #overlay { position:absolute; top:10px; left:10px; color:#fff; z-index:3; font-weight:600; }
    #overlay .small { font-size:12px; opacity:0.8; margin-top:4px; }
    #controls { position:absolute; bottom:16px; left:16px; right:16px; z-index:3;
                display:flex; justify-content:space-between; pointer-events:none; }
    .stick { width:140px; height:140px; border-radius:50%; background:rgba(255,255,255,0.08);
             border:2px solid rgba(255,255,255,0.2); position:relative; pointer-events:auto; }
    .knob { position:absolute; width:64px; height:64px; border-radius:50%; background:rgba(255,255,255,0.25);
            left:calc(50% - 32px); top:calc(50% - 32px); }
    .button { pointer-events:auto; width:80px; height:80px; border-radius:16px;
              background:rgba(255,255,255,0.08); border:2px solid rgba(255,255,255,0.2);
              color:#fff; display:grid; place-items:center; font-weight:700; }
    canvas { display:block; }
  </style>
</head>
<body>
  <div id="overlay">
    <div>Survive: <span id="timer">0.0</span>s | Health: <span id="hp">100</span></div>
    <div class="small">Desktop: WASD/arrows + Space. Mobile: stick + Jump.</div>
  </div>
  <div id="controls">
    <div id="leftStick" class="stick"><div class="knob" id="leftKnob"></div></div>
    <div id="jumpBtn" class="button">JUMP</div>
  </div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x202030);
    const camera = new THREE.PerspectiveCamera(65, window.innerWidth/window.innerHeight, 0.1, 500);

    const hemi = new THREE.HemisphereLight(0xffffff,0x442211,1); scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xfff2d0,1.2); dir.position.set(8,12,6); scene.add(dir);

    const ground = new THREE.Mesh(new THREE.PlaneGeometry(80,80),
      new THREE.MeshStandardMaterial({color:0x223322}));
    ground.rotation.x = -Math.PI/2; scene.add(ground);

    const player = new THREE.Mesh(new THREE.CapsuleGeometry(0.5,0.6,8,16),
      new THREE.MeshStandardMaterial({color:0x66aaff}));
    player.position.set(0,1,0); scene.add(player);

    const enemies=[]; const enemyMat=new THREE.MeshStandardMaterial({color:0xff3322,emissive:0x771108});
    for(let i=0;i<6;i++){ const e=new THREE.Mesh(new THREE.SphereGeometry(0.45,16,16),enemyMat);
      const a=Math.random()*Math.PI*2,d=12+Math.random()*10;
      e.position.set(Math.cos(a)*d,0.45,Math.sin(a)*d); e.userData.speed=2.2+Math.random()*0.8;
      enemies.push(e); scene.add(e); }

    const lava=new THREE.Mesh(new THREE.CylinderGeometry(40,40,0.2,32,1,true),
      new THREE.MeshStandardMaterial({color:0xff3c00,emissive:0xff2200}));
    lava.position.y=-2; scene.add(lava);

    const keys={}; window.addEventListener('keydown',e=>keys[e.code]=true);
    window.addEventListener('keyup',e=>keys[e.code]=false);

    let yaw=0,pitch=0.2,velocity=new THREE.Vector3(),onGround=true,health=100,running=true;
    const timerEl=document.getElementById('timer'),hpEl=document.getElementById('hp');
    let start=performance.now();

    // Mouse look
    let drag=false,last=null;
    renderer.domElement.addEventListener('pointerdown',e=>{drag=true;last={x:e.clientX,y:e.clientY};});
    renderer.domElement.addEventListener('pointerup',()=>{drag=false;last=null;});
    renderer.domElement.addEventListener('pointermove',e=>{
      if(!drag)return; const dx=e.clientX-last.x,dy=e.clientY-last.y; last={x:e.clientX,y:e.clientY};
      yaw-=dx*0.0025; pitch=Math.max(0.05,Math.min(1.2,pitch-dy*0.0025));
    });

    // Joystick
    const leftStick=document.getElementById('leftStick'),leftKnob=document.getElementById('leftKnob');
    let stickVec={x:0,y:0};
    function setKnob(x,y){const r=leftStick.getBoundingClientRect();
      leftKnob.style.left=`${x-r.left-32}px`; leftKnob.style.top=`${y-r.top-32}px`; }
    function handleStick(e,active){const r=leftStick.getBoundingClientRect(),cx=r.left+r.width/2,cy=r.top+r.height/2;
      let x=e.clientX,y=e.clientY; if(e.touches){x=e.touches[0].clientX;y=e.touches[0].clientY;}
      const dx=x-cx,dy=y-cy,len=Math.min(Math.hypot(dx,dy),r.width*0.45);
      const nx=len?dx/len:0,ny=len?dy/len:0;
      if(active){setKnob(cx+nx*len,cy+ny*len); stickVec={x:nx*(len/(r.width*0.45)),y:ny*(len/(r.width*0.45))};}
      else{setKnob(cx,cy); stickVec={x:0,y:0};}}
    leftStick.addEventListener('pointerdown',e=>{handleStick(e,true);});
    leftStick.addEventListener('pointermove',e=>{handleStick(e,true);});
    leftStick.addEventListener('pointerup',e=>{handleStick(e,false);});
    leftStick.addEventListener('touchstart',e=>handleStick(e,true));
    leftStick.addEventListener('touchmove',e=>handleStick(e,true));
    leftStick.addEventListener('touchend',e=>handleStick(e,false));

    // Jump button
    document.getElementById('jumpBtn').addEventListener('pointerdown',()=>{if(onGround)velocity.y=7.5;});
    document.getElementById('jumpBtn').addEventListener('touchstart',()=>{if(onGround)velocity.y=7.5;});

    window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight);});

    let lastT=performance.now();
    function loop(now){const dt=Math.min((now-lastT)/1000,0.05); lastT=now; if(running)update(dt,now);
      renderer.render(scene,camera); requestAnimationFrame(loop);} requestAnimationFrame(loop);

    function update(dt,now){
      // Input
      const f=(keys.KeyW||keys.ArrowUp?1:0)-(keys.KeyS||keys.ArrowDown?1:0)-stickVec.y;
      const s=(keys.KeyD||keys.ArrowRight?1:0)-(keys.KeyA||keys.ArrowLeft?1:0)+stickVec.x;
      const sinY=Math.sin(yaw),cosY=Math.cos(yaw);
      const forward=new THREE.Vector3(sinY,0,-cosY),right=new THREE.Vector3(cosY,0,sinY);
      const wish=new THREE.Vector3().addScaledVector(right,s).addScaledVector(forward,f);
      if(wish.lengthSq()>0)wish.normalize();
      velocity.addScaled
