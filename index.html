<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lava Monkey Jungle — Full Game (Mobile + First‑Person + Shop)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; font-family:system-ui, sans-serif; }
    canvas { display:block; }

    /* HUD and buttons */
    #overlay { position:absolute; top:10px; left:10px; z-index:12; color:#fff; font-weight:700; text-shadow:0 1px 2px #000; user-select:none; }
    #overlay .small { font-size:12px; opacity:0.85; font-weight:500; }
    #viewBtn { position:absolute; top:10px; right:10px; z-index:12; padding:10px 14px; border-radius:12px; border:1px solid #fff2; background:#111a; color:#fff; cursor:pointer; }
    #shopBtn { position:absolute; top:56px; right:10px; z-index:12; padding:10px 14px; border-radius:12px; border:1px solid #fff2; background:#111a; color:#fff; cursor:pointer; }

    #message { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:#fff; z-index:12; text-align:center; font-weight:800; font-size:22px; display:none; }
    #message button { margin-top:12px; background:#ff6a00; border:none; color:#fff; font-weight:800; padding:10px 16px; border-radius:10px; cursor:pointer; }

    /* Shop */
    #shop { position:absolute; top:20%; left:50%; transform:translateX(-50%); background:#1e1e1e; color:#fff; padding:20px; border-radius:12px; display:none; z-index:12; width:320px; border:1px solid #fff2; }
    #shop h2 { margin:0 0 10px; }
    #shop .row { margin:8px 0; display:flex; justify-content:space-between; align-items:center; }
    #shop .row button { padding:6px 10px; border:none; border-radius:8px; background:#444; color:#fff; cursor:pointer; }
    #closeShop { margin-top:12px; width:100%; padding:8px; border:none; border-radius:8px; background:#6a6a6a; color:#fff; cursor:pointer; }

    /* Mobile joysticks and buttons */
    #controls { position:absolute; bottom:16px; left:16px; right:16px; z-index:12; display:flex; justify-content:space-between; align-items:flex-end; pointer-events:none; }
    .stick { width:140px; height:140px; border-radius:50%; background:rgba(255,255,255,0.08); border:2px solid rgba(255,255,255,0.2); position:relative; pointer-events:auto; touch-action:none; }
    .knob { position:absolute; width:64px; height:64px; border-radius:50%; background:rgba(255,255,255,0.25); left:calc(50% - 32px); top:calc(50% - 32px); }
    #rightPanel { display:flex; flex-direction:column; align-items:center; gap:12px; pointer-events:auto; }
    .btn { pointer-events:auto; touch-action:none; width:84px; height:84px; border-radius:16px; background:rgba(255,255,255,0.08); border:2px solid rgba(255,255,255,0.2); color:#fff; display:grid; place-items:center; font-weight:800; }

    * { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body>
  <div id="overlay">
    <div>Survive: <span id="timer">0.0</span>s | Health: <span id="hp">100</span> | Coins: <span id="coins">0</span></div>
    <div class="small">Desktop: WASD/arrows + Space, drag to look, F to attack. Mobile: Left stick = move, Right stick = look (flipped in first‑person); JUMP + ACTION buttons.</div>
  </div>

  <button id="viewBtn">VIEW: FIRST</button>
  <button id="shopBtn">SHOP</button>

  <div id="message">
    <div id="msgText">Game Over — the lava monkeys got you!</div>
    <button id="restart">Restart</button>
  </div>

  <div id="shop">
    <h2>Shop</h2>
    <div class="row"><span>Weapon upgrade</span><button data-cost="10" data-type="weapon">Buy (10)</button></div>
    <div class="row"><span>Map: Night jungle</span><button data-cost="20" data-type="mapNight">Buy (20)</button></div>
    <div class="row"><span>Map: Bright jungle</span><button data-cost="0" data-type="mapDay">Use</button></div>
    <div class="row"><span>Skin: Red</span><button data-cost="15" data-type="skinRed">Buy (15)</button></div>
    <div class="row"><span>Skin: Blue</span><button data-cost="0" data-type="skinBlue">Use</button></div>
    <button id="closeShop">Close</button>
  </div>

  <!-- Mobile controls -->
  <div id="controls">
    <div id="leftStick" class="stick"><div class="knob" id="leftKnob"></div></div>
    <div id="rightPanel">
      <div id="rightStick" class="stick"><div class="knob" id="rightKnob"></div></div>
      <div style="display:flex; gap:12px;">
        <div id="jumpBtn" class="btn">JUMP</div>
        <div id="actionBtn" class="btn">ACTION</div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

    // Renderer
    const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'high-performance' });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    document.body.appendChild(renderer.domElement);

    // Scene & camera
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb); // day sky
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 800);

    // Lights
    const hemi = new THREE.HemisphereLight(0xffffff,0x228822,1.0);
    scene.add(hemi);
    const sun = new THREE.DirectionalLight(0xffffff,1.5); sun.position.set(20,40,10); scene.add(sun);

    // Ground
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(140,140),
      new THREE.MeshStandardMaterial({color:0x228B22, roughness:0.9}));
    ground.rotation.x = -Math.PI/2; scene.add(ground);

    // Jungle trees
    function addTree(x,z){
      const trunk=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.25,2.2,10),
        new THREE.MeshStandardMaterial({color:0x8B4513}));
      trunk.position.set(x,1.1,z);
      const foliage=new THREE.Mesh(new THREE.SphereGeometry(1.3,18,18),
        new THREE.MeshStandardMaterial({color:0x006400}));
      foliage.position.set(x,2.6,z);
      scene.add(trunk,foliage);
    }
    for(let i=0;i<28;i++){ const a=Math.random()*Math.PI*2,d=12+Math.random()*55; addTree(Math.cos(a)*d,Math.sin(a)*d); }

    // Player + weapon
    const playerRadius=0.5;
    const playerMat = new THREE.MeshStandardMaterial({color:0x66aaff});
    const player=new THREE.Mesh(new THREE.CapsuleGeometry(playerRadius,0.6,8,16), playerMat);
    player.position.set(0,playerRadius+0.3,0); scene.add(player);

    const weaponMat = new THREE.MeshStandardMaterial({color:0x885000});
    const weapon=new THREE.Mesh(new THREE.BoxGeometry(0.12,0.7,0.12), weaponMat);
    weapon.position.set(0.45,0.35,0.0); player.add(weapon);

    // Coins and medkits
    let coinCount=0;
    const coins=[]; const medkits=[];
    function spawnCoin(){ const c=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,0.1,24),
      new THREE.MeshStandardMaterial({color:0xFFD700})); c.rotation.x=Math.PI/2;
      c.position.set((Math.random()-0.5)*110,0.15,(Math.random()-0.5)*110); coins.push(c); scene.add(c); }
    function spawnMedkit(){ const m=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.3,0.5),
      new THREE.MeshStandardMaterial({color:0xFF0000})); m.position.set((Math.random()-0.5)*110,0.15,(Math.random()-0.5)*110); medkits.push(m); scene.add(m); }
    for(let i=0;i<14;i++) spawnCoin();
    for(let i=0;i<6;i++) spawnMedkit();

    // Enemies: monkeys
    const enemies=[];
    function createMonkey(){
      const g=new THREE.Group();
      const m=new THREE.MeshStandardMaterial({color:0x7a4b2a});
      const body=new THREE.Mesh(new THREE.SphereGeometry(0.45,16,16),m);
      const head=new THREE.Mesh(new THREE.SphereGeometry(0.28,16,16),m); head.position.set(0,0.52,0.02);
      const earL=new THREE.Mesh(new THREE.SphereGeometry(0.1,8,8),m); earL.position.set(-0.22,0.58,0.02);
      const earR=earL.clone(); earR.position.x=0.22;
      g.add(body,head,earL,earR); return g;
    }
    function spawnEnemy(){
      const e=createMonkey();
      const a=Math.random()*Math.PI*2,d=16+Math.random()*14;
      e.position.set(Math.cos(a)*d,0.45,Math.sin(a)*d);
      e.userData.speed=5.9+Math.random()*0.8;
      enemies.push(e); scene.add(e);
    }
    let running=true;
    let spawnTimer=setInterval(()=>{if(running)spawnEnemy();},1000);

    // Lava
    const lava=new THREE.Mesh(new THREE.CylinderGeometry(80,80,0.3,48,1,true),
      new THREE.MeshStandardMaterial({color:0xff3c00,emissive:0xff2200,emissiveIntensity:0.95}));
    lava.position.y=-2.5; scene.add(lava);

    // State
    let health=100,startTime=performance.now();
    const keys={}; const velocity=new THREE.Vector3();
    const accelGround=16,accelAir=6,friction=12,maxSpeed=7.2,gravity=18,jumpStrength=10.8;
    let onGround=true,yaw=0,pitch=0; let cameraMode='first'; // first or third

    // HUD refs
    const timerEl=document.getElementById('timer'),hpEl=document.getElementById('hp'),coinsEl=document.getElementById('coins');
    const msg=document.getElementById('message'),msgText=document.getElementById('msgText');
    const restartBtn=document.getElementById('restart'); const viewBtn=document.getElementById('viewBtn');
    const jumpBtn=document.getElementById('jumpBtn'); const actionBtn=document.getElementById('actionBtn');
    const shopBtn=document.getElementById('shopBtn'); const shopEl=document.getElementById('shop'); const closeShopBtn=document.getElementById('closeShop');

    // Keyboard
    window.addEventListener('keydown',e=>{ keys[e.code]=true; if(e.code==='Escape') shopEl.style.display='none'; });
    window.addEventListener('keyup',e=>{ keys[e.code]=false; });
    window.addEventListener('keydown',e=>{ if(e.code==='Space'&&onGround&&running) velocity.y=jumpStrength; });
    window.addEventListener('keydown',e=>{ if(e.code==='KeyF'&&running) startAttack(); });

    // Mouse look (yaw/pitch only, no roll)
    let drag=false,last=null;
    renderer.domElement.addEventListener('pointerdown',e=>{ drag=true; last={x:e.clientX,y:e.clientY}; renderer.domElement.setPointerCapture(e.pointerId); });
    renderer.domElement.addEventListener('pointerup',e=>{ drag=false; last=null; renderer.domElement.releasePointerCapture(e.pointerId); });
    renderer.domElement.addEventListener('pointermove',e=>{
      if(!drag||!running) return;
      const dx=e.clientX-last.x,dy=e.clientY-last.y; last={x:e.clientX,y:e.clientY};
      yaw+=dx*0.0025; pitch=THREE.MathUtils.clamp(pitch+dy*0.0024,-1.2,1.2);
    });

    // Joysticks
    function setupStick(stickId,knobId){
      const stick=document.getElementById(stickId),knob=document.getElementById(knobId);
      let vec={x:0,y:0},active=false;
      function setKnob(x,y){ const r=stick.getBoundingClientRect(); knob.style.left=`${x-r.left-32}px`; knob.style.top=`${y-r.top-32}px`; }
      function handle(e,a){
        const r=stick.getBoundingClientRect(),cx=r.left+r.width/2,cy=r.top+r.height/2;
        let x=e.clientX,y=e.clientY; if(e.touches&&e.touches[0]){ x=e.touches[0].clientX; y=e.touches[0].clientY; }
        const dx=x-cx,dy=y-cy,len=Math.min(Math.hypot(dx,dy),r.width*0.45);
        const nx=len?dx/len:0,ny=len?dy/len:0;
        active=a;
        if(a){ setKnob(cx+nx*len,cy+ny*len); vec={x:nx*(len/(r.width*0.45)), y:ny*(len/(r.width*0.45))}; }
        else{ setKnob(cx,cy); vec={x:0,y:0}; }
      }
      stick.addEventListener('pointerdown',e=>{ stick.setPointerCapture(e.pointerId); handle(e,true); });
      stick.addEventListener('pointermove',e=>{ if(active) handle(e,true); });
      stick.addEventListener('pointerup',e=>{ stick.releasePointerCapture(e.pointerId); handle(e,false); });
      stick.addEventListener('touchstart',e=>handle(e,true),{passive:false});
      stick.addEventListener('touchmove',e=>handle(e,true),{passive:false});
      stick.addEventListener('touchend',e=>handle(e,false),{passive:false});
      return { get:()=>vec };
    }
    const moveStick=setupStick('leftStick','leftKnob');
    const lookStick=setupStick('rightStick','rightKnob');

    // UI actions
    jumpBtn.addEventListener('pointerdown',()=>{ if(onGround&&running) velocity.y=jumpStrength; });
    jumpBtn.addEventListener('touchstart',()=>{ if(onGround&&running) velocity.y=jumpStrength; },{passive:true});
    actionBtn.addEventListener('pointerdown',()=>{ if(running) startAttack(); });
    actionBtn.addEventListener('touchstart',()=>{ if(running) startAttack(); },{passive:true});

    viewBtn.addEventListener('click',()=>{
      cameraMode = (cameraMode==='first') ? 'third' : 'first';
      viewBtn.textContent = `VIEW: ${cameraMode.toUpperCase()}`;
    });

    shopBtn.addEventListener('click',()=>{ shopEl.style.display='block'; });
    closeShopBtn.addEventListener('click',()=>{ shopEl.style.display='none'; });
    shopEl.addEventListener('click',(e)=>{
      if(e.target.tagName!=='BUTTON' || e.target.id==='closeShop') return;
      const cost=parseInt(e.target.dataset.cost||'0',10);
      const type=e.target.dataset.type;
      if(cost>coinCount){ alert('Not enough coins'); return; }
      if(cost>0){ coinCount-=cost; coinsEl.textContent=coinCount; }
      applyShop(type);
    });

    function applyShop(type){
      switch(type){
        case 'weapon':
          weapon.scale.set(1.1,1.3,1.1);
          weaponMat.color.set(0x553300);
          attackRange = 1.8;
          break;
        case 'mapNight':
          scene.background = new THREE.Color(0x0a1020);
          hemi.color.set(0xaaccff);
          sun.color.set(0x88aaff);
          sun.intensity = 0.8;
          ground.material.color.set(0x1c3a1c);
          break;
        case 'mapDay':
          scene.background = new THREE.Color(0x87ceeb);
          hemi.color.set(0xffffff);
          sun.color.set(0xffffff);
          sun.intensity = 1.5;
          ground.material.color.set(0x228B22);
          break;
        case 'skinRed':
          playerMat.color.set(0xff4444);
          break;
        case 'skinBlue':
          playerMat.color.set(0x66aaff);
          break;
      }
    }

    // Attack state
    let attacking=false; let attackStart=0;
    let attackDuration=200; let attackRange=1.4; const attackArcCos=Math.cos(Math.PI/3);

    function startAttack(){
      if(attacking) return;
      attacking=true; attackStart=performance.now();
      weapon.rotation.z = -Math.PI*0.35;
      performAttackHit();
      setTimeout(()=>{ attacking=false; weapon.rotation.z=0; }, attackDuration);
    }

    function performAttackHit(){
      const forward=new THREE.Vector3(Math.sin(yaw),0,-Math.cos(yaw));
      const p=player.position.clone();
      for(let i=enemies.length-1;i>=0;i--){
        const e=enemies[i];
        const to=new THREE.Vector3().subVectors(e.position,p);
        const dist=to.length(); if(dist>attackRange) continue;
        to.normalize(); const dot=to.dot(forward);
        if(dot>=attackArcCos){ scene.remove(e); enemies.splice(i,1); }
      }
    }

    // Restart
    restartBtn.addEventListener('click',()=>{
      health=100; running=true; startTime=performance.now();
      velocity.set(0,0,0); player.position.set(0,playerRadius+0.3,0);
      yaw=0; pitch=0; lava.position.y=-2.5;
      enemies.forEach(e=>scene.remove(e)); enemies.length=0;
      coins.forEach(c=>scene.remove(c)); coins.length=0; coinCount=0; coinsEl.textContent=coinCount;
      medkits.forEach(m=>scene.remove(m)); medkits.length=0;
      for(let i=0;i<14;i++) spawnCoin();
      for(let i=0;i<6;i++) spawnMedkit();
      clearInterval(spawnTimer); spawnTimer=setInterval(()=>{if(running)spawnEnemy();},1000);
      msg.style.display='none';
    });

    // Loop
    let lastT=performance.now();
    function loop(now){
      const dt=Math.min((now-lastT)/1000,1/30); lastT=now;
      if(running) update(dt,now);
      renderer.render(scene,camera);
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    function update(dt, now){
      // Look stick: flip in first-person, normal in third-person (no roll)
      const ls = lookStick.get();
      const lookSensitivity = 1.8;
      let lx = ls.x, ly = ls.y;
      if(cameraMode==='first'){ lx = -lx; ly = -ly; } // flipped axes in FP per your request
      yaw += lx * lookSensitivity * dt;
      pitch = THREE.MathUtils.clamp(pitch + ly * lookSensitivity * dt, -1.2, 1.2);

      // Keyboard movement
      const kForward=(keys.KeyW||keys.ArrowUp)?1:0;
      const kBack   =(keys.KeyS||keys.ArrowDown)?1:0;
      const kLeft   =(keys.KeyA||keys.ArrowLeft)?1:0;
      const kRight  =(keys.KeyD||keys.ArrowRight)?1:0;

      // Move stick: flip both axes in third-person movement (kept from earlier behavior)
      const mv=moveStick.get();
      let sx = mv.x, sy = mv.y;
      if(cameraMode==='third'){ sx = -sx; sy = -sy; }

      let inputX = (kRight - kLeft) + sx;
      let inputY = (kForward - kBack) - sy; // stick up is negative y

      // Normalize
      const mag=Math.hypot(inputX,inputY);
      if(mag>1){ inputX/=mag; inputY/=mag; }

      // Direction from yaw
      const sinY=Math.sin(yaw), cosY=Math.cos(yaw);
      const forward=new THREE.Vector3(sinY,0,-cosY);
      const right  =new THREE.Vector3(cosY,0, sinY);
      const wishdir=new THREE.Vector3().addScaledVector(right,inputX).addScaledVector(forward,inputY);
      if(wishdir.lengthSq()>0) wishdir.normalize();

      // Accel/friction
      const accel=onGround?accelGround:accelAir;
      velocity.addScaledVector(wishdir,accel*dt);

      if(onGround && mag<0.05){
        const horiz=new THREE.Vector2(velocity.x,velocity.z);
        const speed=horiz.length();
        const drop=friction*dt;
        const newSpeed=Math.max(speed-drop,0);
        if(speed>0){
          horiz.multiplyScalar(newSpeed/speed);
          velocity.x=horiz.x; velocity.z=horiz.y;
        }
      }

      // Speed cap
      {
        const horiz=new THREE.Vector2(velocity.x,velocity.z);
        const speed=horiz.length();
        if(speed>maxSpeed){
          horiz.multiplyScalar(maxSpeed/speed);
          velocity.x=horiz.x; velocity.z=horiz.y;
        }
      }

      // Gravity/integration
      velocity.y -= gravity * dt;
      player.position.addScaledVector(velocity, dt);

      // Ground collision
      const groundY=playerRadius+0.3;
      if(player.position.y<groundY){ player.position.y=groundY; velocity.y=0; onGround=true; }
      else onGround=false;

      // Camera (no roll)
      if(cameraMode==='first'){
        camera.position.set(player.position.x, player.position.y+1.1, player.position.z);
        camera.rotation.set(0,0,0);
        camera.rotateX(pitch);
        camera.rotateY(yaw);
      } else {
        const camDist=6.0, camHeight=2.5;
        const offset=new THREE.Vector3(Math.sin(yaw)*camDist, camHeight, -Math.cos(yaw)*camDist);
        camera.position.copy(player.position).add(offset);
        camera.lookAt(player.position.x, player.position.y+1.0, player.position.z);
      }

      // Weapon sway / attack anim
      if(!attacking){
        weapon.rotation.x = Math.sin(now*0.004)*0.08;
        weapon.rotation.z = 0;
      } else {
        const t=Math.min((performance.now()-attackStart)/attackDuration,1);
        weapon.rotation.x = -0.2;
        weapon.rotation.z = -Math.PI*0.35 + Math.sin(t*Math.PI)*0.5;
      }

      // Lava rise
      lava.position.y += 0.018 * dt;

      // Enemy AI, separation, damage
      const bob=Math.sin(now*0.004)*0.02;
      for(let i=0;i<enemies.length;i++){
        const e=enemies[i];
        e.position.y=0.45+bob;
        const toP=new THREE.Vector3().subVectors(player.position,e.position);
        const d=toP.length();
        if(d>0.0001) toP.normalize();
        e.position.addScaledVector(toP,e.userData.speed*dt);

        // Separation
        for(let j=i+1;j<enemies.length;j++){
          const f=enemies[j];
          const sep=new THREE.Vector3().subVectors(e.position,f.position);
          const sl=sep.length();
          if(sl>0 && sl<0.9){
            sep.normalize();
            e.position.addScaledVector(sep,(0.9-sl)*0.15);
            f.position.addScaledVector(sep.multiplyScalar(-1),(0.9-sl)*0.15);
          }
        }

        // Damage to player
        if(d<0.85){ health -= 18*dt; if(health<0) health=0; }
      }

      // Collect coins & medkits
      for(let i=coins.length-1;i>=0;i--){
        const c=coins[i];
        if(c.position.distanceTo(player.position)<0.8){
          coinCount+=1; coinsEl.textContent=coinCount;
          scene.remove(c); coins.splice(i,1);
        }
      }
      for(let i=medkits.length-1;i>=0;i--){
        const m=medkits[i];
        if(m.position.distanceTo(player.position)<0.9){
          health = Math.min(100, health+25);
          scene.remove(m); medkits.splice(i,1);
        }
      }

      // Lose conditions
      const feet=player.position.y - groundY;
      const lavaTop=lava.position.y + 0.15;
      if(feet<=lavaTop || health<=0){
        running=false;
        msgText.textContent='Game Over — the lava monkeys got you!';
        msg.style.display='block';
      }

      // HUD
      timerEl.textContent = ((performance.now()-startTime)/1000).toFixed(1);
      hpEl.textContent = Math.round(health);
    }

    // Resize & gesture prevention
    window.addEventListener('resize',()=>{
      camera.aspect=window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth,window.innerHeight);
    });
    document.addEventListener('gesturestart', e => e.preventDefault());
    document.addEventListener('gesturechange', e => e.preventDefault());
    document.addEventListener('gestureend', e => e.preventDefault());
  </script>
</body>
</html>
