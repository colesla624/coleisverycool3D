<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lava Monkey Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <style>
    html, body {
      margin:0;
      height:100%;
      background:#000;
      overflow:hidden;
      touch-action:none;
      font-family:system-ui, sans-serif;
    }
    canvas { display:block; }

    #overlay {
      position:absolute;
      top:10px;
      left:10px;
      z-index:5;
      color:#fff;
      font-weight:700;
      text-shadow:0 1px 2px #000;
    }
    #overlay .small {
      font-size:12px;
      opacity:0.8;
      font-weight:500;
    }

    #controls {
      position:absolute;
      bottom:16px;
      left:16px;
      right:16px;
      z-index:5;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      pointer-events:none;
    }
    .stick {
      width:140px;
      height:140px;
      border-radius:50%;
      background:rgba(255,255,255,0.08);
      border:2px solid rgba(255,255,255,0.2);
      position:relative;
      pointer-events:auto;
      touch-action:none;
    }
    .knob {
      position:absolute;
      width:64px;
      height:64px;
      border-radius:50%;
      background:rgba(255,255,255,0.25);
      left:calc(50% - 32px);
      top:calc(50% - 32px);
    }
    #rightPanel {
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      pointer-events:auto;
    }
    .button {
      pointer-events:auto;
      touch-action:none;
      width:84px;
      height:84px;
      border-radius:16px;
      background:rgba(255,255,255,0.08);
      border:2px solid rgba(255,255,255,0.2);
      color:#fff;
      display:grid;
      place-items:center;
      font-weight:800;
    }
    #viewBtn {
      position:absolute;
      top:16px;
      right:16px;
      z-index:6;
    }
    #message {
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      color:#fff;
      z-index:6;
      text-align:center;
      font-weight:800;
      font-size:24px;
      display:none;
    }
    #message button {
      margin-top:12px;
      background:#ff6a00;
      border:none;
      color:#fff;
      font-weight:800;
      padding:10px 16px;
      border-radius:10px;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div id="overlay">
    <div>
      Survive: <span id="timer">0.0</span>s &nbsp; | &nbsp; Health: <span id="hp">100</span>
    </div>
    <div class="small">
      Desktop: WASD/arrows + Space, drag to look.  
      Mobile: Left stick = move (flipped), Right stick = look, Jump.
    </div>
  </div>

  <div id="controls">
    <div id="leftStick" class="stick">
      <div class="knob" id="leftKnob"></div>
    </div>
    <div id="rightPanel">
      <div id="rightStick" class="stick">
        <div class="knob" id="rightKnob"></div>
      </div>
      <div id="jumpBtn" class="button">JUMP</div>
    </div>
  </div>

  <div id="viewBtn" class="button">VIEW</div>

  <div id="message">
    <div id="msgText">Game Over</div>
    <button id="restart">Restart</button>
  </div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

    // Renderer setup
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Scene and camera
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x171b26);
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 800);

    // Lighting
    scene.add(new THREE.HemisphereLight(0xffffff,0x332211,1.0));
    const sun = new THREE.DirectionalLight(0xfff2d0,1.2);
    sun.position.set(8,12,6);
    scene.add(sun);

    // Ground
    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(120,120),
      new THREE.MeshStandardMaterial({color:0x204020, roughness:0.9})
    );
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    // Player capsule (invisible, used for collisions)
    const playerRadius=0.5;
    const player = new THREE.Mesh(
      new THREE.CapsuleGeometry(playerRadius,0.6,8,16),
      new THREE.MeshStandardMaterial({visible:false})
    );
    player.position.set(0,playerRadius+0.3,0);
    scene.add(player);

    // Enemies
    const enemies=[];
    const enemyMat=new THREE.MeshStandardMaterial({color:0xff3322,emissive:0x771108,emissiveIntensity:0.7});
    const enemyGeo=new THREE.SphereGeometry(0.45,16,16);

    function spawnEnemy(){
      const e=new THREE.Mesh(enemyGeo,enemyMat);
      const a=Math.random()*Math.PI*2;
      const d=16+Math.random()*14;
      e.position.set(Math.cos(a)*d,0.45,Math.sin(a)*d);
      e.userData.speed=2.4+Math.random()*0.9;
      enemies.push(e);
      scene.add(e);
    }
    let spawnTimer=setInterval(()=>{if(running)spawnEnemy();},1000);

    // Lava
    const lava=new THREE.Mesh(
      new THREE.CylinderGeometry(80,80,0.3,48,1,true),
      new THREE.MeshStandardMaterial({color:0xff3c00,emissive:0xff2200,emissiveIntensity:0.95})
    );
    lava.position.y=-2.5;
    scene.add(lava);

    // Game state
    let running=true,health=100,startTime=performance.now();
    const keys={};
    const velocity=new THREE.Vector3();
    const accelGround=16,accelAir=6,friction=12,maxSpeed=7.2,gravity=18,jumpStrength=7.8;
    let onGround=true,yaw=0,pitch=0;
    let cameraMode="first";

    // UI elements
    const timerEl=document.getElementById('timer');
    const hpEl=document.getElementById('hp');
    const msg=document.getElementById('message');
    const msgText=document.getElementById('msgText');
    const restartBtn=document.getElementById('restart');

    // Keyboard input
    window.addEventListener('keydown',e=>keys[e.code]=true);
    window.addEventListener('keyup',e=>keys[e.code]=false);
    window.addEventListener('keydown',e=>{
      if(e.code==='Space'&&onGround&&running)velocity.y=jumpStrength;
    });

    // Mouse look
    let drag=false,last=null;
    renderer.domElement.addEventListener('pointerdown',e=>{drag=true;last={x:e.clientX,y:e.clientY};});
    renderer.domElement.addEventListener('pointerup',()=>{drag=false;last=null;});
    renderer.domElement.addEventListener('pointermove',e=>{
      if(!drag||!running)return;
      const dx=e.clientX-last.x,dy=e.clientY-last.y;
      last={x:e.clientX,y:e.clientY};
      yaw+=dx*0.0025;
      pitch=THREE.MathUtils.clamp(pitch+dy*0.0024,-1.2,1.2);
    });

    // Joystick setup
    function setupStick(stickId,knobId){
      const stick=document.getElementById(stickId);
      const knob=document.getElementById(knobId);
      let vec={x:0,y:0},active=false;

